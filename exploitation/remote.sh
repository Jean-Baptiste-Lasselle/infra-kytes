#!/bin/bash

# - > à exécuter depusi un poste debian, sur leequel git est installé, ainsi que SSH

export MAISON_OPS=$HOME/running-kytes-backup-restore-ops
export URI_DE_CETTE_RECETTE=https://github.com/Jean-Baptiste-Lasselle/infra-kytes
export USER_LX_OPERATEUR_SERVEUR_DISTANT=jibl
export NOM_HOTE_RESEAU_SERVEUR_DISTANT=production-docker-host-1.kytes.io
export CHEMIN_MAISON_KYTES_DRP='/media/jibl/Seagate\ Slim\ Drive'
export CHEMIN_MAISON_KYTES_DRP="$CHEMIN_MAISON_KYTES_DRP/kytes-production-drp"

cd MAISON_OPS


export UUID_DE_MON_DISQUE_DUR_EXTERNE=70BE639EBE635B9A

export UUID_DE_MON_DISQUE_DUR_EXTERNE=$(sudo blkid|grep Seagate|awk '{print $5}'|awk -F '"' '{print $2}')
echo "UUID_DE_MON_DISQUE_DUR_EXTERNE=$UUID_DE_MON_DISQUE_DUR_EXTERNE"

# redhat grown ...
if [ "UUID_DE_MON_DISQUE_DUR_EXTERNE" == "x$UUID_DE_MON_DISQUE_DUR_EXTERNE" ]; then
  echo "La procédure de backup ne trovue pas le disque dur externe Seagate: Est-il bien branché? "
  echo "Procédez aux vérifications, puis relancez ce script"
  exit 1
fi

git clone "$URI_DE_CETTE_RECETTE" . 

cd exploitation
chmod +x ./monter-disque-dur-externe.sh
./monter-disque-dur-externe.sh $UUID_DE_MON_DISQUE_DUR_EXTERNE
# attention, pour exécuter silencieusement la recette, il sera encore mieux de 
# coller, surle serveur distant, ma clé publique RSA dans les $HOME/jibl/.ssh/authorized_keys
# ssh $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT "bash -s" -- < ./ex.bash "--time" "bye"
export NOM_FICHIER_ZIP_PRODUIT=$(ssh $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT "bash -s" -- < ./backup.sh)

scp $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT:/home/jibl/infra-kytes/$NOM_FICHIER_ZIP_PRODUIT ./$NOM_FICHIER_ZIP_PRODUIT

# Et il ne reste plus qu'à copier le zip obtenu dans le stockage physiquement distinct: backup restore de type (1,2)
echo "Je suis $(whoami), et je backup l'infra kytes vers "
cp -rf  /media/jibl/Seagate\ Slim\ Drive/kytes-production-drp
