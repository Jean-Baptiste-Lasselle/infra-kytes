#!/bin/bash

# +-+-+-+ [--sysctl net.core.somaxconn=1024 \] cf. [https://gitlab.com/gitlab-org/omnibus-gitlab/issues/1350]
export NOMBRE_MAXIMAL_DE_CONNEXIONS_ENTRANTES_ACCEPTEES=1024
# pour configurer cette limite pour tous les utilisateurs du groupe 'docker' : 
echo "# Increase number of incoming connections on Docker host, for ruuning Gitlab containers" >> ./ajout-en-fin-de-conf.tmp
echo "net.core.somaxconn = $NOMBRE_MAXIMAL_DE_CONNEXIONS_ENTRANTES_ACCEPTEES" >> ./ajout-en-fin-de-conf.tmp
sudo cat ./ajout-en-fin-de-conf.tmp >> /etc/sysctl.d/999-kytes-dockerhosts.conf


# +-+-+-+ [--ulimit sigpending=62793 \] cf. [https://gitlab.com/gitlab-org/omnibus-gitlab/issues/1350]
export MAX_NO_OF_PENDING_SIGNALS=62793
echo "root               hard    sigpending       $MAX_NO_OF_PENDING_SIGNALS" >> /etc/security/limits.d/999-kytes-dockerhosts.conf
echo "@docker               hard    sigpending       $MAX_NO_OF_PENDING_SIGNALS" >> /etc/security/limits.d/999-kytes-dockerhosts.conf


# +-+-+-+ [--ulimit nproc=131072 \] cf. [https://gitlab.com/gitlab-org/omnibus-gitlab/issues/1350]
export MAX_NO_OF_PROCESSUS=131072
echo "root               hard    nproc       $MAX_NO_OF_PROCESSUS" >> /etc/security/limits.d/999-kytes-dockerhosts.conf
echo "@docker               hard    nproc       $MAX_NO_OF_PENDING_SIGNALS" >> /etc/security/limits.d/999-kytes-dockerhosts.conf


# +-+-+-+ [--ulimit nofile=60000 \] cf. [https://gitlab.com/gitlab-org/omnibus-gitlab/issues/1350]
export MAX_NO_OF_OPEN_FILES=60000
# nope, sup {60 000, 1 000 000} = 1 000 000
export MAX_NO_OF_OPEN_FILES=1000000
echo "root               hard    nofile       $MAX_NO_OF_OPEN_FILES" >> /etc/security/limits.d/999-kytes-dockerhosts.conf
echo "@docker               hard    nofile       $MAX_NO_OF_OPEN_FILES" >> /etc/security/limits.d/999-kytes-dockerhosts.conf
# But that's not how [https://gitlab.com/ReSearchITEng] does that, he does  :
[[ $(cat /proc/sys/fs/file-max) -lt ${MAX_NO_OF_OPEN_FILES} ]] && echo $MAX_NO_OF_OPEN_FILES > /proc/sys/fs/file-max
# because [/proc/sys/fs/file-max is shared between containerization host and containers, among which Gitlab's
