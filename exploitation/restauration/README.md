# Principe

Cette recette suppose :
* que la cible de restauration est dans l'état suivant : 
  * CentOS7 est installé, 
  * Un utilisateur linux adminsitrateur est existant dans le CentOS 7
  * L'horodatage système est mis en oeuvre avec configuration service NTP
  * `docker` et `docker-compose` son installés.
  * `git`, `zip` et `unzip` sont installés.

# Utilisation

À exécuter sur le poste opérateur : 

```bash
# - 
# d'abord, il faut s'assurer que l'horodatage système est bien synchronisé
# sur le serveur NTP principal configuré dans [/etc/ntp.conf]
# - 
# L'horodatage de la présente
# - 
export HORODATAGE_OPS=$(date '+%Y-%m-%dday_%Hh-%Mmin-%Ssec')
export OPERATIONS_HOME=/kytes-ops/restaurations/$HORODATAGE_OPS/


# L'URI du repo Git de versionning de la recette de provision
export URI_RECETTE_PROVISION_KYTES=https://github.com/Jean-Baptiste-Lasselle/infra-kytes

# l'utilisateur linux, opérateur légitime sur la machine cible
export USER_LX_OPERATEUR_SERVEUR_DISTANT=jibl
# le nom de l'hôte réseau de la machine cible
export NOM_HOTE_RESEAU_SERVEUR_DISTANT=production-docker-host-1.kytes.io

# UUID du disque dur externe contenant le backup à partir duquel on va faire la restauration
# Ce disque dur externe doit être connecté sur le poste matériel de l'opérateur
export UUID_DE_MON_DISQUE_DUR_EXTERNE=70BE639EBE635B9A
export CHEMIN_MONTAGE_DISQUE_DUR_EXTERNE_DRP=/media/jbl/disque/dur/externe/pour/bckups/kytes-bckup-storage-$HORODATAGE_OPS
export CHEMIN_MAISON_KYTES_DRP=$CHEMIN_MONTAGE_DISQUE_DUR_EXTERNE_DRP/kytes-production-drp
export REPERTOIRE_EXPLOITATION_KYTES_DANS_SERVEUR=/home/jibl/infra-kytes


if [ -d $OPERATIONS_HOME ]; then echo "C'est inattendu, mais [$OPERATIONS_HOME] existe déjà"; sudo rm -rf $OPERATIONS_HOME; fi;
sudo mkdir -p $OPERATIONS_HOME

cd $OPERATIONS_HOME

# 0./ Je remonte le disque dur externe DRP
./monter-disque-dur-externe-drp.sh $UUID_DE_MON_DISQUE_DUR_EXTERNE $CHEMIN_MONTAGE_DISQUE_DUR_EXTERNE_DRP ntfs-3g

# 0.bis./ Je demande à l'utilisateur de choisir le backup à partir duquel effectuer la restauration
clear
echo " --------------------------------------------------------------------------------- "
echo "  Voici les backup disponible :  "
echo " --------------------------------------------------------------------------------- "
ls -all $CHEMIN_MAISON_KYTES_DRP
echo " --------------------------------------------------------------------------------- "
echo "  Saisissez le nom du fichier de backup sur la base duquel effectuer cette  "
echo "  restauration de l'infrastruture Kytes (puis pressez entrée) : "
echo " --------------------------------------------------------------------------------- "
read FICHIER_BACKUP_CHOISIT
echo "  "
echo " Vous confirmez que vous souhaitez restaurer Kytes sur la base du "
echo " fichier de backup  [$CHEMIN_MAISON_KYTES_DRP/$FICHIER_BACKUP_CHOISIT]"
read -p "  (o/n)?" choix


REPONSE_VALIDE="FAUX"

while [ $REPONSE_VALIDE == "FAUX" ]
do
case "$choix" in 
  o|O| ) echo " vous avez confirmé la restauration sur la base du fichier de backup [$CHEMIN_MAISON_KYTES_DRP/$FICHIER_BACKUP_CHOISIT] "; REPONSE_VALIDE="VRAI";;
  n|N ) echo " vous avez annulé la restauration sur la base du fichier de backup [$CHEMIN_MAISON_KYTES_DRP/$FICHIER_BACKUP_CHOISIT] "; REPONSE_VALIDE="VRAI"; exit 1 ;;
  * ) echo " Vous devez répondre par Oui, en sasissant la lettre 'o', ou par non, en saissant la lettre 'n' "; REPONSE_VALIDE="FAUX" ;;
esac
done
echo " --------------------------------------------------------------------------------- "


# 1./ je récupère le zip, et l'envoi sur le serveur
scp -i ~./.ssh/id_rsa $CHEMIN_MAISON_KYTES_DRP/$FICHIER_BACKUP_CHOISIT $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT:~/.

# 2./ sur le serveur, j'exécute la restauration à partir du zip envoyé
echo "Connectez-vous maintenant sur la machine cible avec l'instruction : "
echo " [ssh -i ~./.ssh/id_rsa $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT] "
echo " Puis Exécutez la restauration sur la machine cible : "
echo " [  ] "



```

À exécuter sur la machine cible, le script `./restauration.sh` : 

```bash
# - 
# d'abord, il faut s'assurer que l'horodatage système est bien synchronisé
# sur le serveur NTP principal configuré dans [/etc/ntp.conf]
# -
sudo ntpd -gq
# - 
# L'horodatage de la présente opération de restauration
# - 
export HORODATAGE_OPS=$(date '+%Y-%m-%dday_%Hh-%Mmin-%Ssec')
export OPERATIONS_HOME=/kytes-ops/restaurations/$HORODATAGE_OPS/


# L'URI du repo Git de versionning de la recette de provision
# https://github.com/Jean-Baptiste-Lasselle/infra-kytes
export URI_RECETTE_PROVISION_KYTES=$1



# Le chemin absolu du fichier de BACKUP envoyé sur la machine cible, par l'opérateur, pour effectuer cette restauration
export CHEMIN_ABSOLU_FICHIER_BACKUP=$2


# l'utilisateur linux, opérateur légitime sur la machine cible
export USER_LX_OPERATEUR_SERVEUR_DISTANT=jibl

export CHEMIN_MAISON_KYTES_DRP=/media/jbl/disque/dur/externe/pour/bckups/kytes-bckup-storage-$HORODATAGE_OPS

export REPERTOIRE_EXPLOITATION_KYTES_DANS_SERVEUR=/home/jibl/infra-kytes


if [ -d $OPERATIONS_HOME ]; then echo "Cest inattendu, mais [$OPERATIONS_HOME] existe déjà"; sudo rm -rf $OPERATIONS_HOME; fi;
sudo mkdir -p $OPERATIONS_HOME

cd $OPERATIONS_HOME

if [ -d $REPERTOIRE_EXPLOITATION_KYTES_DANS_SERVEUR ]; then echo " [$REPERTOIRE_EXPLOITATION_KYTES_DANS_SERVEUR] existe déjà, et va être supprimé et re-créé pour la restauration"; sudo rm -rf $REPERTOIRE_EXPLOITATION_KYTES_DANS_SERVEUR; fi;
sudo mkdir -p $REPERTOIRE_EXPLOITATION_KYTES_DANS_SERVEUR

git clone "URI_RECETTE_PROVISION_KYTES" $REPERTOIRE_EXPLOITATION_KYTES_DANS_SERVEUR
chmod +x $REPERTOIRE_EXPLOITATION_KYTES_DANS_SERVEUR/*.sh
chmod +x $REPERTOIRE_EXPLOITATION_KYTES_DANS_SERVEUR/exploitation/*.sh
chmod +x $REPERTOIRE_EXPLOITATION_KYTES_DANS_SERVEUR/exploitation/restauration/*.sh

```

# 
