# Principe

Cette recette suppose que la cible de restauration est dans l'état suivant : 
  * CentOS7 est installé, 
  * Un utilisateur linux adminsitrateur est existant dans le CentOS 7, à disposition pour l'opérateur de l'équipe IAAS-to-SAAS
  * L'horodatage système est mis en oeuvre avec configuration service NTP
  * `docker` et `docker-compose` son installés.
  * `git`, `zip` et `unzip` sont installés.

# Utilisation

À exécuter sur le poste opérateur : 

```bash
# - 
# d'abord, il faut s'assurer que l'horodatage système est bien synchronisé
# sur le serveur NTP principal configuré dans [/etc/ntp.conf]
# - 
# L'horodatage de la présente
# - 
export HORODATAGE_OPS=$(date '+%Y-%m-%dday_%Hh-%Mmin-%Ssec')
export OPERATIONS_HOME=/kytes-ops/restaurations/$HORODATAGE_OPS/


# L'URI du repo Git de versionning de la recette de provision
export URI_RECETTE_PROVISION_KYTES=https://github.com/Jean-Baptiste-Lasselle/infra-kytes
export URI_RECETTE_RESTAURATION_KYTES=https://github.com/Jean-Baptiste-Lasselle/infra-kytes
# l'utilisateur linux, opérateur légitime sur la machine cible
export USER_LX_OPERATEUR_SERVEUR_DISTANT=jibl
# le nom de l'hôte réseau de la machine cible
export NOM_HOTE_RESEAU_SERVEUR_DISTANT=production-docker-host-1.kytes.io

# ------------------ #
# --- OPERATIONS --- #
# ------------------ #

if [ -d $OPERATIONS_HOME ]; then echo "C'est inattendu, mais [$OPERATIONS_HOME] existe déjà"; sudo rm -rf $OPERATIONS_HOME; fi;
mkdir -p $OPERATIONS_HOME

cd $OPERATIONS_HOME

git clone "$URI_RECETTE_RESTAURATION_KYTES" .
chmod +x ./*.sh
chmod +x ./exploitation/*.sh
chmod +x ./exploitation/restauration/partie-poste-operateur.sh
./exploitation/restauration/partie-poste-operateur.sh $URI_RECETTE_PROVISION_KYTES $URI_RECETTE_RESTAURATION_KYTES


```
## Terraformation

Pour mettre à jour mon /etc/hosts sur les  postes utilisateurs en attendant DNS : 

```bash
# Tranformera les occurrences de '192.168.1.30', par '192.168.1.32'
sudo sed -i 's/30/32/g' /etc/hosts
# re-configuration de l'interface réseau `ifcfg-enp0s10`
sudo sed -i 's/ONBOOT=no/ONBOOT=yes/g' /etc/sysconfig/network-scripts/ifcfg-enp0s10

```

L'interface réseau par défaut, de l'instance d'OS CentOS 7, conventionnelement désignée par `0.0.0.0`, en l'état de cofniguraton pointe sur la boucle locale, `127.0.0.1` : 
```bash
[jbl@vm-172 ~]$ ping -c 4 0.0.0.0
PING 0.0.0.0 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.055 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.042 ms
64 bytes from 127.0.0.1: icmp_seq=3 ttl=64 time=0.043 ms
```
appliquer https://www.cyberciti.biz/faq/linux-setup-default-gateway-with-route-command/ : 
```bash
# my router is at 192.168.1.1
route default gw 192.168.1.1 
```

Création de ma VM, configuration des disques (peut être démultiplié à 3 disques physiques, tournant sur 6 ports SATA, je veux pouvoir garder des marges sur les pannes de bus SATA de l'underlay)

`./preparation-vm.sh` : interactif, suppose git installé, configure les disques, le service NTP, installe docker, docker-compose.

```bash
export PROVISIONING_HOME=$HOME/provision-hote-docker
mkdir -p $PROVISIONING_HOME
cd $PROVISIONING_HOME

sudo yum update -y
sudo yum install -y vim curl wget git

clear
echo "  "
echo " Exécutez les instrcutions de : "
echo "  "
echo "  htt "
echo "  "
echo " Pressez la touche Entrée pour poursuivre les opérations. "
echo "  "
read ATTENTEZERO

cd $PROVISIONING_HOME

clear
echo "  "
echo " Exécutez les instrcutions de : "
echo "  "
echo "  htt "
echo "  "
echo " Pressez la touche Entrée pour poursuivre les opérations. "
echo "  "
read ATTENTEZEROBIS

cd $PROVISIONING_HOME

clear
echo "  "
echo " ==============>>>>> ===================== <<<<<============== "
echo " ==============>>>>>   CONFIG. PARTITIONS  <<<<<============== "
echo " ==============>>>>> ===================== <<<<<============== "
echo "  "

# pour obtenir les noms de disques, et le nom de leur partitions associées
sudo fdisk -l
# pour obtenir les UUID de disque
sudo blkid
# pour formater le gros disque dur , dont on a trouvé le nom
export NOM_DISQUE_OS=/dev/sdb
export NOM_GROS_DISQUE_DATA=/dev/sdc

clear
echo "  "
echo "  Ouvrez une nouvelle sessiosn linux shell paralèlle, et exécutez-y : "
echo "  "
echo "  sudo fidisk $NOM_GROS_DISQUE_DATA  "
echo "  "
echo "  là, suivre l'aide interactive pour formater deux "
echo "  "
echo "  partition de [$NOM_GROS_DISQUE_DATA] prenant chacune la moitié de l'espace : `/dev/sdb1` et `/dev/sdb2` "
echo "  "
echo "    Par exemple `/dev/sdx1` et `/dev/sdx2` "
echo "  "
echo "  "
echo "  "
echo "  "
read ATTENTE1
# et
# 






# -------------------------------------- #
# ------   [/infra-kytes]   ------ #
# -------------------------------------- #

# pour créer le répertoire sur lequel monter la partition
sudo mkdir -p /infra-kytes
# Puis monter la première partition du gros disque dur, sur le répertoire `/infra-kytes`
clear
echo " " 
sudo fdisk -l
echo " " 
echo "Quelle est la partition que vous souhaitez réserver à l'infra kytes ? "
echo " (un truc genre `/dev/sdh1` ... )"
echo "  "
echo "  Saissez le nom de device de la partition, puis pressez la touche Entrée. "
echo "  " 
# un truc genre `/dev/sdh1` ... DE_LA_PARTTION_RESERVEE_INFRA_PROD_KYTES_BUSINESS
read DEVICE_NAME1

# export UUID_PARTITION_RESERVEE_INFRA_PROD_KYTES_BUSINESS=2c05271f-07db-462d-bbaa-c6f3216c15e6
# résolution du UUID de la partition désignée par l'opérateur
sudo blkid|grep $DEVICE_NAME1|awk '{print $2}'|awk -F '"' '{print $2}' >> ./UUID_PARTITION_RESERVEE_INFRA_PROD_KYTES_BUSINESS.kytes
export UUID_PARTITION_RESERVEE_INFRA_PROD_KYTES_BUSINESS=$(cat ./UUID_PARTITION_RESERVEE_INFRA_PROD_KYTES_BUSINESS.kytes)

# rendre le montage automatique au boot centos
echo "# montage de la partition du disque de données réservée à l'exploitation de la [prod. kytes / business] " >> ./etc.fstab.ajout
echo "UUID=$UUID_PARTITION_RESERVEE_INFRA_PROD_KYTES_BUSINESS /infra-kytes ext4  errors=remount-ro 0 1" >> ./etc.fstab.ajout
sudo cat ./etc.fstab.ajout  >> /etc/fstab
echo "  "
echo " VERIF CONTENU /etc/fstab "
echo "  "
sudo cat /etc/fstab
echo "  "
echo "  Pressez Entrée pour poursuivre les opérations. "
echo "  "
read ATTENTE2



# [mount -a] va recharger la cofiguration `/etc/fstab`, que je viens de mettre à jour, si bien que le montage sera immédiat
sudo mount -a
# pour vérifier /infra-kytes
# (savoir quel est la partition montée sur un répertoire, le volume restant et utilisé sur cette partition)
df -Th /infra-kytes

# -------------------------------------- #
# ------   [/kytes-lab]   ------ #
# -------------------------------------- #


# pour créer le répertoire sur lequel monter la partition
sudo mkdir -p /kytes-lab
# Puis monter la seconde partition du gros disque dur, sur le répertoire `/kytes-lab`
clear
echo " " 
sudo fdisk -l
echo " " 
echo "Quelle est la partition que vous souhaitez réserver au lab kytes, dans [/kytes-lab] ? "
echo " (un truc genre `/dev/sdh2` ... )"
echo "  "
echo "  Saissez le nom de device de la partition, puis pressez la touche Entrée. "
echo "  " 
# un truc genre `/dev/sdh2` ... DE_LA_PARTTION_RESERVEE_INFRA_KYTES_LAB
read DEVICE_NAME2

# export UUID_PARTITION_RESERVEE_INFRA_KYTES_LAB=c6f3216c15e6-462d-07db-bbaa-2c05271f
# résolution du UUID de la partition désignée par l'opérateur
sudo blkid|grep $DEVICE_NAME2|awk '{print $2}'|awk -F '"' '{print $2}' >> ./UUID_PARTITION_RESERVEE_INFRA_KYTES_LAB.kytes
export UUID_PARTITION_RESERVEE_INFRA_KYTES_LAB=$(cat ./UUID_PARTITION_RESERVEE_INFRA_KYTES_LAB.kytes)

# rendre le montage automatique au boot centos
echo "# montage de la partition du disque de données réservée à l'exploitation de l' [infra. kytes / labs] " >> ./etc.fstab.ajout
sudo rm -f ./etc.fstab.ajout
echo "UUID=$UUID_PARTITION_RESERVEE_INFRA_KYTES_LAB /kytes-lab ext4  errors=remount-ro 0 1" >> ./etc.fstab.ajout
sudo cat ./etc.fstab.ajout  >> /etc/fstab
echo "  "
echo " VERIF CONTENU /etc/fstab "
echo "  "
sudo cat /etc/fstab
echo "  "
echo "  Pressez Entrée pour poursuivre les opérations. "
echo "  "
read ATTENTE3

# [mount -a] va recharger la cofiguration `/etc/fstab`, que je viens de mettre à jour, si bien que le montage sera immédiat
sudo mount -a
# pour vérifier `/kytes-lab`
# (savoir quel est la partition montée sur un répertoire, le volume restant et utilisé sur cette partition)
df -Th /kytes-lab


# - MISC 
# + 
# + montage de partitions ext 4 de disques SATA virtualisés
# + 
# mounting as ext4 filesystem, with acl and attributes management allowed. 
# cf. https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/storage_administration_guide/ext4mount
# + 
# 
```


