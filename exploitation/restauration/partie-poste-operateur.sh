#!/bin/bash

# - 
# d'abord, il faut s'assurer que l'horodatage système est bien synchronisé
# sur le serveur NTP principal configuré dans [/etc/ntp.conf]
# - 
# L'horodatage de la présente
# - 
export HORODATAGE_OPS=$(date '+%Y-%m-%dday_%Hh-%Mmin-%Ssec')

# L'URI du repo Git de versionning de la recette de provision
export URI_RECETTE_PROVISION_KYTES=$1
# L'URI du repo Git de versionning de la recette de restauration
export URI_RECETTE_RESTAURATION_KYTES=$2

# l'utilisateur linux, opérateur légitime sur la machine cible
export USER_LX_OPERATEUR_SERVEUR_DISTANT=jibl
# le nom de l'hôte réseau de la machine cible
export NOM_HOTE_RESEAU_SERVEUR_DISTANT=production-docker-host-1.kytes.io

# UUID du disque dur externe contenant le backup à partir duquel on va faire la restauration
# Ce disque dur externe doit être connecté sur le poste matériel de l'opérateur
export UUID_DE_MON_DISQUE_DUR_EXTERNE=70BE639EBE635B9A
export CHEMIN_MONTAGE_DISQUE_DUR_EXTERNE_DRP=/media/jbl/disque/dur/externe/pour/bckups/kytes-bckup-storage-$HORODATAGE_OPS
export CHEMIN_MAISON_KYTES_DRP=$CHEMIN_MONTAGE_DISQUE_DUR_EXTERNE_DRP/kytes-production-drp
export REPERTOIRE_EXPLOITATION_KYTES_DANS_SERVEUR=/home/jibl/infra-kytes


chmod +x ./exploitation/restauration/monter-disque-dur-externe-drp.sh
# 0./ Je remonte le disque dur externe DRP
./exploitation/restauration/monter-disque-dur-externe-drp.sh $UUID_DE_MON_DISQUE_DUR_EXTERNE $CHEMIN_MONTAGE_DISQUE_DUR_EXTERNE_DRP ntfs-3g

# 0.bis./ Je demande à l'utilisateur de choisir le backup à partir duquel effectuer la restauration
clear
echo " --------------------------------------------------------------------------------- "
echo "  Voici les backup disponible :  "
echo " --------------------------------------------------------------------------------- "
ls -all $CHEMIN_MAISON_KYTES_DRP
echo " --------------------------------------------------------------------------------- "
echo "  Saisissez le nom du fichier de backup sur la base duquel effectuer cette  "
echo "  restauration de l'infrastruture Kytes (puis pressez entrée) : "
echo " --------------------------------------------------------------------------------- "
read FICHIER_BACKUP_CHOISIT
echo "  "
echo " Vous confirmez que vous souhaitez restaurer Kytes sur la base du "
echo " fichier de backup  [$CHEMIN_MAISON_KYTES_DRP/$FICHIER_BACKUP_CHOISIT]"
read -p "  (o/n)?" choix


REPONSE_VALIDE="FAUX"

while [ $REPONSE_VALIDE == "FAUX" ]
do
case "$choix" in 
  o|O ) echo " vous avez confirmé la restauration sur la base du fichier de backup [$CHEMIN_MAISON_KYTES_DRP/$FICHIER_BACKUP_CHOISIT] "; REPONSE_VALIDE="VRAI";;
  n|N ) echo " vous avez annulé la restauration sur la base du fichier de backup [$CHEMIN_MAISON_KYTES_DRP/$FICHIER_BACKUP_CHOISIT] "; REPONSE_VALIDE="VRAI"; exit 1 ;;
  * ) echo " Vous devez répondre par Oui, en sasissant la lettre 'o', ou par non, en saissant la lettre 'n' "; REPONSE_VALIDE="FAUX" ;;
esac
done
echo " --------------------------------------------------------------------------------- "


# 1./ je récupère le zip, et l'envoi sur le serveur
scp -i ~/.ssh/id_rsa $CHEMIN_MAISON_KYTES_DRP/$FICHIER_BACKUP_CHOISIT $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT:~/

echo "  "
echo " J'essaie de générer un fichier dans le HOME de l'opérateur  : "
echo "  "
echo "  "

# ssh -i ~/.ssh/id_rsa $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT] -C "rm -f ~/kytes-boot-restauration.sh"
if [ -f ./kytes-boot-restauration.sh ]; then rm -f ./kytes-boot-restauration.sh; echo " suppression ./kytes-boot-restauration.sh "; else echo "  le fichier ./kytes-boot-restauration.sh n'existe pas ";  fi

export COMMANDE="#!/bin/bash"
# ssh -i ~/.ssh/id_rsa $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT] -C "echo \"$COMMANDE\" >> ~/kytes-boot-restauration.sh"
echo "$COMMANDE" >> ./kytes-boot-restauration.sh

export COMMANDE="export BOOT_RESTAURATION=~/boot-restauration"
# ssh -i ~/.ssh/id_rsa $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT] -C "echo \"$COMMANDE\" >> ~/kytes-boot-restauration.sh"
echo "$COMMANDE" >> ./kytes-boot-restauration.sh

export COMMANDE="if [ -d \$BOOT_RESTAURATION ]; then sudo rm -rf \$BOOT_RESTAURATION && mkdir -p \$BOOT_RESTAURATION; fi;"
# ssh -i ~/.ssh/id_rsa $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT] -C "echo \"$COMMANDE\" >> ~/kytes-boot-restauration.sh"
echo "$COMMANDE" >> ./kytes-boot-restauration.sh

export COMMANDE="cd \$BOOT_RESTAURATION "
# ssh -i ~/.ssh/id_rsa $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT] -C "echo \"$COMMANDE\" >> ~/kytes-boot-restauration.sh"
echo "$COMMANDE" >> ./kytes-boot-restauration.sh

export COMMANDE="git clone \"$URI_RECETTE_RESTAURATION_KYTES\" . "
# ssh -i ~/.ssh/id_rsa $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT] -C "echo \"$COMMANDE\" >> ~/kytes-boot-restauration.sh"
echo "$COMMANDE" >> ./kytes-boot-restauration.sh

export COMMANDE="chmod +x ./exploitation/restauration/*.sh "
# ssh -i ~/.ssh/id_rsa $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT] -C "echo \"$COMMANDE\" >> ~/kytes-boot-restauration.sh"
echo "$COMMANDE" >> ./kytes-boot-restauration.sh

export COMMANDE="./exploitation/restauration/partie-sur-cible.sh $URI_RECETTE_PROVISION_KYTES $URI_RECETTE_RESTAURATION_KYTES $CHEMIN_MAISON_KYTES_DRP/$FICHIER_BACKUP_CHOISIT"
# ssh -i ~/.ssh/id_rsa $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT] -C "echo \"$COMMANDE\" >> ~/kytes-boot-restauration.sh"
echo "$COMMANDE" >> ./kytes-boot-restauration.sh

# - 
# Le fichier de script généré sur le serveur distant, est prêt, il ne reste plus qu'à 
# le rendre exécutable (pour l'utilisateur linux de l'opérateur)
# - 

# ssh -i ~/.ssh/id_rsa $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT] -C "chmod +x ~/kytes-boot-restauration.sh"
chmod +x ./kytes-boot-restauration.sh

# 1./ j'envoie ./kytes-boot-restauration.sh sur le serveur 
scp -i ~/.ssh/id_rsa ./kytes-boot-restauration.sh $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT:~/


# - 
# 2./ J'indique à l'opérateur comment exécuter la restauration sur la cible
# - 
clear
echo "  "
echo "Connectez-vous maintenant sur la machine cible avec l'instruction : "
echo "  "
echo " [ssh -i ~/.ssh/id_rsa $USER_LX_OPERATEUR_SERVEUR_DISTANT@$NOM_HOTE_RESEAU_SERVEUR_DISTANT] "
echo "  "
echo " Puis Exécutez la restauration sur la machine cible en exécutant : "
echo " [~/kytes-boot-restauration.sh] "
echo "  "
# - 
