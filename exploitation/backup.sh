#!/bin/bash
export CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR=./monbckupleplusrecent.zip
# export NOM_FICHIER_ZIP_PRODUIT=kytes-bckup-$(date --iso-8601=seconds).zip
export HRODATAGE_WITH_CUSTOMER_LOCALE=$(date '+%Y-%m-%dday_%Hh-%Mmin-%Ssec')
export NOM_FICHIER_ZIP_PRODUIT=kytes-bckup-$HRODATAGE_WITH_CUSTOMER_LOCALE.zip

# => exemple d'invocation : 
# export CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR=$CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR 
# cd $REPERTOIRE_EXPLOITATION_KYTES_DANS_SERVEUR 
# ./backup.sh

# on éteind les lumières, pour pouvoir travailler tranquille
docker-compose down

echo "  "
echo " BACKUP : vérif [CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR=$CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR] "
ls -all .
echo "  "
echo " BACKUP : vérif [NOM_FICHIER_ZIP_PRODUIT=$NOM_FICHIER_ZIP_PRODUIT] "
echo "  "

sudo yum install -y zip unzip
sudo zip -r $NOM_FICHIER_ZIP_PRODUIT ./gitlab ./db ./volumes && echo "$NOM_FICHIER_ZIP_PRODUIT"
# pour que mon poulet puisse récupérer ça sans être root, avec scp 
sudo chmod +r $NOM_FICHIER_ZIP_PRODUIT
# sudo ln -s ./$NOM_FICHIER_ZIP_PRODUIT_QUI_CONTIENT_DATE_IMPREVISISBLE   ./most_recent_backup.zip
# removing previous symbolic link, if it exists
echo "removing previous symbolic link [$CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR], if it exists... "
if [ -f $CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR ]; then rm -f $CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR; echo " removed symbolic link at [$CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR], and will recreate it"; fi;
if [ -f $CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR ]; then echo "there was no previous symbolic link at [$CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR]"; fi;
sudo ln -s ./$NOM_FICHIER_ZIP_PRODUIT   $CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR
# pour que mon poulet puisse récupérer ça sans être root, avec scp
sudo chmod a+r $CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR

zip -T $NOM_FICHIER_ZIP_PRODUIT || exit 1
# on renvoie les lumières, show must go on
docker-compose up -d

