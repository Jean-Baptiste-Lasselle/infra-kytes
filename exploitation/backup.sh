#!/bin/bash

# export NOM_FICHIER_ZIP_PRODUIT=kytes-bckup-$(date --iso-8601=seconds).zip
export NOM_FICHIER_ZIP_PRODUIT=kytes-bckup-$(date '+%Y-%m-%dday_%Hh-%Mmin-%Ssec').zip
sudo yum install -y zip unzip
sudo zip -r $NOM_FICHIER_ZIP_PRODUIT ./gitlab ./db ./volumes && echo "$NOM_FICHIER_ZIP_PRODUIT" 


# TODO ==>>>>>>>> Ce script devra avoir un argument : le UUID du disque dur externe qui sert au backup
#                      le UUID enregistré une première fois pour le disque dur externe SEAGATE : 70BE639EBE635B9A


# 1. je veux récupérer le UUID de mon disque dur externe "Seagate". TOut ce que je sais, c'est qu'il y a un genre de label sur le disque, incluant le mot [Seagate]

export UUID_DE_MON_DISQUE_DUR_EXTERNE=70BE639EBE635B9A
export UUID_DE_MON_DISQUE_DUR_EXTERNE=$(sudo blkid|grep Seagate|awk '{print $5}'|awk -F '"' '{print $2}')
echo "UUID_DE_MON_DISQUE_DUR_EXTERNE=$UUID_DE_MON_DISQUE_DUR_EXTERNE"

# redhat grown ...
if [ "UUID_DE_MON_DISQUE_DUR_EXTERNE" == "x$UUID_DE_MON_DISQUE_DUR_EXTERNE" ]; then
  echo "La procédure de backup ne trovue pas le disque dur externe Seagate: Est-il bien branché? "
  echo "Procédez aux vérifications, puis relancez ce script"
  exit 1
fi


# 2. Je veux créer le répertoire surlequel je vais monter le disque dur externe: Ce répertoire sera différent à chaque backup, il ne sera jamais le même, par sécurité.
export REPERTOIRE_DE_MONTAGE_DISQUE_DUR_EXTERNE=/media/jbl/disque/dur/externe/pour/bckups/kytes-bckup-storage-$(date '+%Y-%m-%dday_%Hh-%Mmin-%Ssec')

# Avant toute opération, je commence par démonter le disque potentiellement monté, quelque soit son point de montage
sudo umount UUID=$UUID_DE_MON_DISQUE_DUR_EXTERNE
# Je créée mon répertoire, en le détruisant d'abord, s'il existe  
if [ -d $REPERTOIRE_DE_MONTAGE_DISQUE_DUR_EXTERNE ]; then
  echo "Le répertoire $REPERTOIRE_DE_MONTAGE_DISQUE_DUR_EXTERNE exite, il va être détruit, pour être re-créé "
  sudo rm -rf $REPERTOIRE_DE_MONTAGE_DISQUE_DUR_EXTERNE
fi
# Salut biloute
mkdir -p $REPERTOIRE_DE_MONTAGE_DISQUE_DUR_EXTERNE

echo " AVANT MONTAGE DISQUE DUR EXTERNE, VERIFICATION CONTENU [REPERTOIRE_DE_MONTAGE_DISQUE_DUR_EXTERNE=$REPERTOIRE_DE_MONTAGE_DISQUE_DUR_EXTERNE] "
# 3. Enfin, on remonte le disque dur externe, sur la base de son UUID
sudo mount -t ntfs-3g UUID=$UUID_DE_MON_DISQUE_DUR_EXTERNE $REPERTOIRE_DE_MONTAGE_DISQUE_DUR_EXTERNE

# 4. Parfait, je suis maintenant prêt pour balancer mon backup au niveau applis
