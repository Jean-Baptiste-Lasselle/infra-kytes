#!/bin/bash
export CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR=./monbckupleplusrecent.zip
# TODO: un de ces jours, je répondrai à cette question => es-ce qu' il existe dans le futur, 2 instants différents, quitte à 
#       ce qu'ils soient chacun dans deux journées distinctes à deux dates espacées de dix millions d'années, tels que la
#       valeur calculée par l'expression $(date '+%Y-%m-%dday_%Hh-%Mmin-%Ssec') retourne exactement la même valeur.
# 
#       pour le vérifier, il faudra utiliser, dasn dix millions d'années, la version suivante de linux : 
#       (ci-dessous l'affichage de la commande `uname -a`) 
# 
#        linux en version $(uname -a) `Linux pc-alienware-jbl 4.9.0-7-amd64 #1 SMP Debian 4.9.110-3+deb9u2 (2018-08-13) x86_64 GNU/Linux`
# 
#       (ci-dessous l'affichage de la commande `cat /etc/os-release`) 
# 
#        jbl@pc-alienware-jbl:/media/jbl/disque/dur/externe/pour/bckups/kytes$ cat /etc/os-release
#        PRETTY_NAME="Debian GNU/Linux 9 (stretch)"
#        NAME="Debian GNU/Linux"
#        VERSION_ID="9"
#        VERSION="9 (stretch)"
#        ID=debian
#        HOME_URL="https://www.debian.org/"
#        SUPPORT_URL="https://www.debian.org/support"
#        BUG_REPORT_URL="https://bugs.debian.org/"
#        
#        

export HORODATAGE_WITH_CUSTOMER_LOCALE=$(date '+%Y-%m-%dday_%Hh-%Mmin-%Ssec')
export NOM_FICHIER_ZIP_PRODUIT=kytes-bckup-$HORODATAGE_WITH_CUSTOMER_LOCALE.zip


# on éteind les lumières, pour pouvoir travailler tranquille
docker-compose stop

echo "  "
echo " BACKUP : vérif [CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR=$CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR] "
ls -all .
echo "  "
echo " BACKUP : vérif [NOM_FICHIER_ZIP_PRODUIT=$NOM_FICHIER_ZIP_PRODUIT] "
echo "  "

sudo yum install -y zip unzip
sudo zip -r $NOM_FICHIER_ZIP_PRODUIT ./gitlab ./db ./volumes && echo "$NOM_FICHIER_ZIP_PRODUIT"
sha512sum $NOM_FICHIER_ZIP_PRODUIT >> $NOM_FICHIER_ZIP_PRODUIT.sha512sum

# pour que mon poulet puisse récupérer ça sans être root, avec scp 
# stupide sans le 'a' ... ^o^ 
sudo chmod a+r $NOM_FICHIER_ZIP_PRODUIT
sudo chmod a+r $NOM_FICHIER_ZIP_PRODUIT.sha512sum
# sudo ln -s ./$NOM_FICHIER_ZIP_PRODUIT_QUI_CONTIENT_DATE_IMPREVISISBLE   ./most_recent_backup.zip
# removing previous symbolic link, if it exists
echo "removing previous symbolic link [$CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR], if it exists... "
if [ -f $CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR ]; then rm -f $CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR; echo " removed symbolic link at [$CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR], and will recreate it"; fi;
if [ -f $CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR ]; then echo "there was no previous symbolic link at [$CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR]"; fi;
sudo ln -s ./$NOM_FICHIER_ZIP_PRODUIT   $CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR
# pour que mon poulet puisse récupérer ça sans être root, avec scp
sudo chmod a+r $CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR

if [ -f ./$NOM_FICHIER_ZIP_PRODUIT.integrity ]; then rm -f ./$NOM_FICHIER_ZIP_PRODUIT.integrity; echo " removed unexpected exiting [./$NOM_FICHIER_ZIP_PRODUIT.integrity] file, and will recreate it to log [./$NOM_FICHIER_ZIP_PRODUIT]'s integrity check log"; fi;
zip -T $NOM_FICHIER_ZIP_PRODUIT || exit 1 >> ./$NOM_FICHIER_ZIP_PRODUIT.integrity.log


# show must go on
docker-compose up -d

