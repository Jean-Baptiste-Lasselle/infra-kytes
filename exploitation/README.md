# Opérations standard d'exploitation

Dans ce répertoire, se trouve les scripts qui permettent d'exécuter toutes les opérations standard d'exploitation, 

# Utilisation

## backup

Exécutez : 

```bash
export HORODATAGE_OPS=$(date '+%Y-%m-%dday_%Hh-%Mmin-%Ssec')
# export OPERATIONS_HOME=/kytes-ops/$HORODATAGE_OPS/
# sudo mkdir -p $OPERATIONS_HOME
export OPERATIONS_HOME=/kytes-ops/$HORODATAGE_OPS/

export URI_DE_CETTE_RECETTE=https://github.com/Jean-Baptiste-Lasselle/infra-kytes

export USER_LX_OPERATEUR_SERVEUR_DISTANT=jibl
export NOM_HOTE_RESEAU_SERVEUR_DISTANT=production-docker-host-1.kytes.io

export UUID_DE_MON_DISQUE_DUR_EXTERNE=70BE639EBE635B9A
export CHEMIN_MAISON_KYTES_DRP=/media/jbl/disque/dur/externe/pour/bckups/kytes-bckup-storage-$HORODATAGE_OPS

export REPERTOIRE_EXPLOITATION_KYTES_DANS_SERVEUR=/home/jibl/infra-kytes
# export CHEMIN_LIEN_SYMBOLIQUE_BCKUP_DS_SERVEUR=./most_recent_backup.zip


if [ -d $OPERATIONS_HOME ]; then sudo rm -rf $OPERATIONS_HOME; fi;
mkdir -p $OPERATIONS_HOME
cd $OPERATIONS_HOME
git clone "https://github.com/Jean-Baptiste-Lasselle/infra-kytes" .
chmod +x exploitation/*.sh
# TODO @Jean-Baptiste-Lasselle => switch remote.sh and backup.sh filenames
./exploitation/remote.sh

```
Soit, en une seule ligne :

```bash
cccc
```
NB :
```bash
echo " !!!!!!!!!!!  TRES TRES TRES IMPORTANT : le git clone devr récupérer exactement la même version que celle sur le serveur en RUN"
echo " !!!!!!!!!!!  TRES TRES TRES IMPORTANT : le git clone devr récupérer exactement la même version que celle sur le serveur en RUN"
echo " !!!!!!!!!!!  TRES TRES TRES IMPORTANT : le git clone devr récupérer exactement la même version que celle sur le serveur en RUN"
echo " !!!!!!!!!!!  TRES TRES TRES IMPORTANT : le git clone devr récupérer exactement la même version que celle sur le serveur en RUN"
echo " !!!!!!!!!!!  TRES TRES TRES IMPORTANT : le git clone devr récupérer exactement la même version que celle sur le serveur en RUN"
echo " !!!!!!!!!!!  TRES TRES TRES IMPORTANT : le git clone devr récupérer exactement la même version que celle sur le serveur en RUN"
echo " !!!!!!!!!!!  TRES TRES TRES IMPORTANT : le git clone devr récupérer exactement la même version que celle sur le serveur en RUN"
# TODO ==>>>> farie évoluer pour cloner une version bien idntifiée, iso avec le serveur cible. / oh purée la fatigue :) ...
# git clone "$URI_DE_CETTE_RECETTE" . 
```
## Automatisation / silence des opérations standards


Dons la config la plus nulle pour SSH avec paire clé publique / privée RSA 8192 :
* 0. Le serveur doit être configuré de la manière suivante : 
  *  openssh-server doit y être installé
  * la configuration de l'authentification par défaut doit être active:  elle se base sur usePAM et login mot de passe de l'utilsiateur Linux

* 1. [POSTE OPERATEUR] générer une parie de clés publique/privée, sur le poste depuis lequel on va se connecter au serveur : 

```bash
ssh-keygen -t rsa -b 8192
# répondre aux 3 questions en pressant la tocuhe entré, pour laisser les valeurs par défaut s'appliquer
```
* 2. [POSTE OPERATEUR] copier la clé publique dans le répertoire .ssh du serveur cible, l'ajouter à `~/.ssh/authorized_keys`
```bash
export UTILISATEUR_LINUX_DANS_LE_SERVEUR=jibl
export HOTE_RESEAU_SERVEUR_A_CONFIGURER=production-docker-host-1.kytes.io
echo " Attention, vous devez connaître le mot de passe de [$UTILISATEUR_LINUX_DANS_LE_SERVEUR] sur le seruveur [$HOTE_RESEAU_SERVEUR_A_CONFIGURER]"
scp ~/.ssh/id_rsa.pub  $UTILISATEUR_LINUX_DANS_LE_SERVEUR@$HOTE_RESEAU_SERVEUR_A_CONFIGURER:.ssh/cle_pub_de_mon_poste
ssh $UTILISATEUR_LINUX_DANS_LE_SERVEUR@$HOTE_RESEAU_SERVEUR_A_CONFIGURER -C "cat .ssh/cle_pub_de_mon_poste >> .ssh/authorized_keys"

```
* 3. [SERVEUR CiBLE] Modifier la configuration openssh-server sur le serveur cible

Sur le serveur cible, une configuration 'sudoers' doit avoir été faite, pour l'utilisateur Linux qui procède à la la reconfiguration openssh-server sur la machine serveuir cible. Cette configuration suoders doit permettre, à l'utilisateur (qui doit être administrateur), d'exécuter avec élévation de droits (avec `sudo`), et sans saisie de mot de passe les instructions suivantes :

* `/usr/bin/sed -i 's/# PubkeyAuthentication yes/PubkeyAuthentication yes/g' /etc/ssh/sshd_config `
* `/usr/binsystemctl restart sshd`
* `/usr/binsystemctl daemon-reload`

Ce qui donne une configuration à ajouter en fin de fichier `/etc/sudoers` : 

```bash
# Members of the marguerite group may gain root privileges
%marguerite  ALL=(ALL) NOPASSWD:/usr/bin/sed -i 's/# PubkeyAuthentication yes/PubkeyAuthentication yes/g' /etc/ssh/sshd_config, /usr/binsystemctl restart sshd, /usr/binsystemctl daemon-reload
```



Pour info : 

```bash
jbl@pc-alienware-jbl:/iaas/virtualbox/kytes-run/ops$ ssh -i ~/.ssh/id_rsa jibl@production-docker-host-1.kytes.io
Last login: Sat Oct 27 16:47:51 2018 from pc-alienware-jbl.home
[jibl@pc-100 ~]$ which systemctl
/usr/bin/systemctl
[jibl@pc-100 ~]$ which openssh-server
/usr/bin/which: no openssh-server in (/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/home/jibl/.local/bin:/home/jibl/bin:/usr/bin/docker-compose:/usr/bin/docker-compose:/usr/bin/docker-compose:/usr/bin/docker-compose)
[jibl@pc-100 ~]$ which sed
/usr/bin/sed
[jibl@pc-100 ~]$ 
```



Exécutez donc : 

```bash
export UTILISATEUR_LINUX_DANS_LE_SERVEUR=jibl
export HOTE_RESEAU_SERVEUR_A_CONFIGURER=production-docker-host-1.kytes.io


export COMMANDE1="sudo sed -i 's/# PubkeyAuthentication yes/PubkeyAuthentication yes/g' /etc/ssh/sshd_config"
ssh $UTILISATEUR_LINUX_DANS_LE_SERVEUR@$HOTE_RESEAU_SERVEUR_A_CONFIGURER -C "$COMMANDE1"
# les droits exacts qu'il faut donner sur le répertoire .ssh et le fichier .ssh/authorized_keys
# export COMMANDE2="sudo -u $UTILISATEUR_LINUX_DANS_LE_SERVEUR chmod -R 700 ~/.ssh"
# ssh $UTILISATEUR_LINUX_DANS_LE_SERVEUR@$HOTE_RESEAU_SERVEUR_A_CONFIGURER -C "$COMMANDE2"
# export COMMANDE3="sudo -u $UTILISATEUR_LINUX_DANS_LE_SERVEUR chmod -R 640 ~/.ssh/authorized_keys"
# ssh $UTILISATEUR_LINUX_DANS_LE_SERVEUR@$HOTE_RESEAU_SERVEUR_A_CONFIGURER -C "$COMMANDE3"
ssh $UTILISATEUR_LINUX_DANS_LE_SERVEUR@$HOTE_RESEAU_SERVEUR_A_CONFIGURER -C "sudo systemctl daemon-reload"
ssh $UTILISATEUR_LINUX_DANS_LE_SERVEUR@$HOTE_RESEAU_SERVEUR_A_CONFIGURER -C "sudo systemctl restart sshd"


```

Et je peux me connecter avec : `ssh -i ~/.ssh/id_rsa jibl@production-docker-host-1.kytes.io`

Testez ceci : 

```bash

# TEST FINAL 

echo " Simplement pour vous le faire bel et bien remarquer:  sachez que vous êtes le USER LINUX [$USER], "
ssh -i ~/.ssh/id_rsa  $UTILISATEUR_LINUX_DANS_LE_SERVEUR@$HOTE_RESEAU_SERVEUR_A_CONFIGURER -C "echo \" Et que sur le serveur distant, vous êtes le USER LINUX [\$USER]\" "

```



## détails

Soit, pour chaque release : 
* `backup.sh` : 

Le backup 1/2 est réalise vers une cible : disque dur externe Seagate 500 Go, branché en USB sur le serveur hôte de virutalisation (un alienware de merde)

```bash
jbl@pc-alienware-demerde:~$ # sudo mount -t ntfs-3g /dev/sdg1 /media/jbl/disque/dur/externe/pour/bckups/kytes
jbl@pc-alienware-demerde:~$ sudo blkid
/dev/sde1: SEC_TYPE="msdos" LABEL="DellUtility" UUID="5450-4444" TYPE="vfat" PARTUUID="76055135-01"
/dev/sde2: LABEL="RECOVERY" UUID="1C749089749066F4" TYPE="ntfs" PARTUUID="76055135-02"
/dev/sde3: UUID="2c05271f-07db-462d-bbaa-c6f3216c15e6" TYPE="ext4" PARTUUID="76055135-03"
/dev/sdf1: UUID="64eb1b64-b26d-4314-bdcd-2e23f9461e0d" TYPE="ext4" PARTUUID="34fdd845-01"
/dev/sdf5: UUID="f8604e28-35f6-4234-92f1-dc9ba8aaab5b" TYPE="swap" PARTUUID="34fdd845-05"
/dev/sdf6: UUID="3bd9fe79-2189-4857-9aa8-7f95b67797c5" TYPE="ext4" PARTUUID="34fdd845-06"
/dev/sdg1: LABEL="Seagate Slim Drive" UUID="70BE639EBE635B9A" TYPE="ntfs" PARTUUID="77c975a2-01"
jbl@pc-alienware-demerde:~$ 

```

La persistance du montage du disque dur externe pourrait être réalisée avec une entrée fstab : 

```bash
UUID=70BE639EBE635B9A /media/jbl/disque/dur/externe/pour/bckups/kytes ntfs-3g  errors=remount-ro 0 1
```

Cependant, je préfère dynamiquement, dans la procédure de backup, résliser le montage à la volée, pour que mon démarrage hôte de virtualisation ne soit pas emmerdé si mon disque dur externe n'est pas branché sur port USB du serveur.

Voici une démo en interactif : 

```bash
jbl@pc-alienware-demerde:~$ sudo blkid
/dev/sde1: SEC_TYPE="msdos" LABEL="DellUtility" UUID="5450-4444" TYPE="vfat" PARTUUID="76055135-01"
/dev/sde2: LABEL="RECOVERY" UUID="1C749089749066F4" TYPE="ntfs" PARTUUID="76055135-02"
/dev/sde3: UUID="2c05271f-07db-462d-bbaa-c6f3216c15e6" TYPE="ext4" PARTUUID="76055135-03"
/dev/sdf1: UUID="64eb1b64-b26d-4314-bdcd-2e23f9461e0d" TYPE="ext4" PARTUUID="34fdd845-01"
/dev/sdf5: UUID="f8604e28-35f6-4234-92f1-dc9ba8aaab5b" TYPE="swap" PARTUUID="34fdd845-05"
/dev/sdf6: UUID="3bd9fe79-2189-4857-9aa8-7f95b67797c5" TYPE="ext4" PARTUUID="34fdd845-06"
/dev/sdg1: LABEL="Seagate Slim Drive" UUID="70BE639EBE635B9A" TYPE="ntfs" PARTUUID="77c975a2-01"
jbl@pc-alienware-demerde:~$ ls -all /media/jbl/disque/dur/externe/pour/bckups/kytes/
total 287161
drwxrwxrwx 1 root root     12288 Oct 26 18:58 .
drwxr-xr-x 3 jbl  jbl       4096 Oct 26 18:55 ..
-rwxrwxrwx 2 root root     76079 Sep 11 04:37 20180911094137.pdf
-rwxrwxrwx 2 root root    107001 Sep 11 04:38 20180911094239.pdf
-rwxrwxrwx 1 root root        30 Jul 16  2012 Autorun.inf
drwxrwxrwx 1 root root      4096 Sep 18 11:57 BOSSTEK
drwxrwxrwx 1 root root         0 Sep 18 03:57 coquelicot
drwxrwxrwx 1 root root         0 Dec 12  2017 EASE
drwxrwxrwx 1 root root     28672 Oct 26 19:03 JUSTE_POUR_JIB
drwxrwxrwx 1 root root         0 Oct 26 12:20 kytes-production-drp
-rwxrwxrwx 2 root root       790 Apr 19  2016 liste2016.xspf.lnk
-rwxrwxrwx 2 root root       879 Apr 21  2017 OpenOffice.org 2.3.lnk
drwxrwxrwx 1 root root      4096 Sep  2  2014 OUTILS.UTILISES.PAR.VINSE.EN.AFRIQUE
drwxrwxrwx 1 root root      4096 May  8  2016 $RECYCLE.BIN
-rwxrwxrwx 2 root root     14680 Oct 23  2013 Réunion Charme n°1.docx
drwxrwxrwx 1 root root         0 Mar 26  2013 Seagate
-rwxrwxrwx 2 root root 135415338 Mar  7  2013 Seagate Dashboard Installer.dmg
-rwxrwxrwx 2 root root 156167544 Mar  7  2013 Seagate Dashboard Installer.exe
-rwxrwxrwx 2 root root       297 Apr 10  2015 Seagate Slim Drive (D) - Raccourci.lnk
-rwxrwxrwx 1 root root   2184846 Feb  8  2013 SlimIcon.ico
drwxrwxrwx 1 root root      4096 Sep 13 18:58 System Volume Information
drwxrwxrwx 1 root root      4096 Apr 27  2017 Video
jbl@pc-alienware-demerde:~$ sudo umount UUID=70BE639EBE635B9A
jbl@pc-alienware-demerde:~$ ls -all /media/jbl/disque/dur/externe/pour/bckups/kytes/
total 8
drwxr-xr-x 2 jbl demerde 4096 Oct 26 18:55 .
drwxr-xr-x 3 jbl demerde 4096 Oct 26 18:55 ..
jbl@pc-alienware-demerde:~$ sudo mount -t ntfs-3g UUID=70BE639EBE635B9A /media/jbl/disque/dur/externe/pour/bckups/kytes
jbl@pc-alienware-demerde:~$ ls -all /media/jbl/disque/dur/externe/pour/bckups/kytes/
total 287161
drwxrwxrwx 1 root root     12288 Oct 26 18:58 .
drwxr-xr-x 3 jbl  jbl       4096 Oct 26 18:55 ..
-rwxrwxrwx 2 root root     76079 Sep 11 04:37 20180911094137.pdf
-rwxrwxrwx 2 root root    107001 Sep 11 04:38 20180911094239.pdf
-rwxrwxrwx 1 root root        30 Jul 16  2012 Autorun.inf
drwxrwxrwx 1 root root      4096 Sep 18 11:57 BOSSTEK
drwxrwxrwx 1 root root         0 Sep 18 03:57 coquelicot
drwxrwxrwx 1 root root         0 Dec 12  2017 EASE
drwxrwxrwx 1 root root     28672 Oct 26 19:03 JUSTE_POUR_JIB
drwxrwxrwx 1 root root         0 Oct 26 12:20 kytes-production-drp
-rwxrwxrwx 2 root root       790 Apr 19  2016 liste2016.xspf.lnk
-rwxrwxrwx 2 root root       879 Apr 21  2017 OpenOffice.org 2.3.lnk
drwxrwxrwx 1 root root      4096 Sep  2  2014 OUTILS.UTILISES.PAR.VINSE.EN.AFRIQUE
drwxrwxrwx 1 root root      4096 May  8  2016 $RECYCLE.BIN
-rwxrwxrwx 2 root root     14680 Oct 23  2013 Réunion Charme n°1.docx
drwxrwxrwx 1 root root         0 Mar 26  2013 Seagate
-rwxrwxrwx 2 root root 135415338 Mar  7  2013 Seagate Dashboard Installer.dmg
-rwxrwxrwx 2 root root 156167544 Mar  7  2013 Seagate Dashboard Installer.exe
-rwxrwxrwx 2 root root       297 Apr 10  2015 Seagate Slim Drive (D) - Raccourci.lnk
-rwxrwxrwx 1 root root   2184846 Feb  8  2013 SlimIcon.ico
drwxrwxrwx 1 root root      4096 Sep 13 18:58 System Volume Information
drwxrwxrwx 1 root root      4096 Apr 27  2017 Video
jbl@pc-alienware-demerde:~$ 
```
